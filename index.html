<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Monitoreo de Planta</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <header>
    <h1>🌿 Monitoreo de Planta</h1>
    <p>Control de condiciones ambientales</p>
  </header>

  <main class="dashboard">
    <section class="sensor-data">
      <div class="sensor-card">
        <h2>🌡️ Temperatura Ambiente</h2>
        <p id="temp">-- °C</p>
      </div>
      <div class="sensor-card">
        <h2>💧 Humedad Ambiente</h2>
        <p id="humedad">-- %</p>
      </div>
      <div class="sensor-card">
        <h2>🌱 Humedad del Suelo</h2>
        <p id="suelo">-- %</p>
      </div>
      <div class="sensor-card">
        <h2>☀️ Luz Solar</h2>
        <p id="luz">-- lux</p>
      </div>
    </section>

    <section class="foto-planta">
      <h2>📸 Foto de la Planta</h2>
      <input type="file" name="imagenPlanta" id="imagenPlanta" accept="image/*" />
      <br /><br />
      <img id="planta-img" src="https://via.placeholder.com/400x300?text=Planta+Actual" alt="Foto de la planta" />
    </section>
  </main>

  <footer>
    <p>Creado por Bruno Hnchaño • 2025</p>
  </footer>

  <section id="galeria">
    <h2>Galería</h2>
    <div id="imagenesSubidas" style="margin-top: 20px; display:flex; flex-wrap: wrap;"></div>
  </section>

  <!-- Modal para imagen grande -->
  <div id="modalImagen" class="close">
    <img src="" alt="Imagen ampliada" />
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    const API_KEY = "2bd99dc7efd4559f644a56cb82dde35f";

    const firebaseConfig = {
      apiKey: "AIzaSyDJLXsig2LOLo22-Ual9XB-Nc3eLBHU5G4",
      authDomain: "huerta-cea2.firebaseapp.com",
      databaseURL: "https://huerta-cea2-default-rtdb.firebaseio.com",
      projectId: "huerta-cea2",
      storageBucket: "huerta-cea2.appspot.com",
      messagingSenderId: "192548596876",
      appId: "1:192548596876:web:0eded2d83c93fbb49c1fa9"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const sensorRef = db.ref('sensores');
    const galeriaRef = db.ref('galeria_imagenes');

    // Actualizar datos sensores y foto planta
    sensorRef.on('value', (snapshot) => {
      const data = snapshot.val();
      if (data) {
        document.getElementById('temp').textContent = `${data.temperatura} °C`;
        document.getElementById('humedad').textContent = `${data.humedad_ambiente} %`;
        document.getElementById('suelo').textContent = `${data.humedad_suelo} %`;
        document.getElementById('luz').textContent = `${data.luz} lux`;
        if (data.imagen_url) {
          document.getElementById('planta-img').src = data.imagen_url;
        }
      }
    });

    // Mostrar galería
    galeriaRef.on('value', (snapshot) => {
      const galeriaDiv = document.getElementById('imagenesSubidas');
      galeriaDiv.innerHTML = '';

      const imgs = snapshot.val();
      if (imgs) {
        Object.values(imgs).forEach(url => {
          const img = document.createElement('img');
          img.src = url;
          img.alt = "Imagen galería";
          img.title = "Clic para ampliar";
          img.addEventListener('click', () => abrirModal(url));
          galeriaDiv.appendChild(img);
        });
      } else {
        galeriaDiv.textContent = "No hay imágenes en la galería.";
      }
    });

    // Subir imagen planta y guardar en Firebase + ImgBB
    document.getElementById('imagenPlanta').addEventListener('change', function() {
      const file = this.files[0];
      if (!file) return alert('Selecciona una imagen');

      const reader = new FileReader();
      reader.onloadend = function() {
        const base64Image = reader.result.split(',')[1];

        fetch(`https://api.imgbb.com/1/upload?key=${API_KEY}`, {
          method: "POST",
          body: new URLSearchParams({ image: base64Image })
        })
        .then(res => res.json())
        .then(data => {
          const url = data.data.url;
          sensorRef.update({ imagen_url: url });
          galeriaRef.push(url);
          alert('Imagen subida correctamente y actualizada.');
          document.getElementById('imagenPlanta').value = "";
        })
        .catch(err => {
          console.error(err);
          alert('Error al subir imagen');
        });
      };
      reader.readAsDataURL(file);
    });

    // Modal imagen
    const modal = document.getElementById('modalImagen');
    const modalImg = modal.querySelector('img');

    function abrirModal(url) {
      modalImg.src = url;
      modal.style.display = 'flex';
    }

    // Cerrar modal al hacer clic fuera de la imagen
    modal.addEventListener('click', (e) => {
      if (e.target === modal || e.target === modalImg) {
        modal.style.display = 'none';
        modalImg.src = '';
      }
    });

    // Cerrar modal con tecla ESC
    document.addEventListener('keydown', (e) => {
      if (e.key === "Escape" && modal.style.display === 'flex') {
        modal.style.display = 'none';
        modalImg.src = '';
      }
    });
  </script>
</body>
</html>

